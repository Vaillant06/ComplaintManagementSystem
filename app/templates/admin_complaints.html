{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white d-flex justify-content-between">
            <h4 >All Complaints</h4>

            <!-- FILTER FUNCTIONALITY -->
            <form method="GET" action="{{ url_for('admin.admin_complaints') }}" class="mb-3">
                <select name="status" class="form-select w-auto d-inline-block mx-2">
                    
                    <option value="" {% if not status %}selected{% endif %}>
                        All
                    </option>

                    <option value="Pending" {% if status == 'Pending' %}selected{% endif %}>
                        Pending
                    </option>

                    <option value="In Progress" {% if status == 'In Progress' %}selected{% endif %}>
                        In Progress
                    </option>

                    <option value="Resolved" {% if status == 'Resolved' %}selected{% endif %}>
                        Resolved
                    </option>

                    <option value="Rejected" {% if status == 'Rejected' %}selected{% endif %}>
                        Rejected
                    </option>

                </select>

                <button class="btn btn-light btn-sm p-2">
                    <i class="bi bi-sliders2 me-1"></i>
                    Filter
                </button>
            </form>
        </div>

        <!-- COMPLAINTS TABLE -->
        <div class="card-body p-0">
            {% if complaints %}
            <table class="table table-hover  mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Details</th>
                        <th>Action</th>
                    </tr>
                </thead>
                
                <tbody>
                    {% for c in complaints %}
                    <tr>
                        <td># {{ c.complaint_id }}</td>
                        <td>{{ c.user_id }}</td>
                        <td>{{ c.username }}</td>
                        <td>{{ c.title }}</td>
                        <td>
                            {% if c.status == "Pending" %}
                                <span class="badge bg-warning text-dark">Pending</span>

                            {% elif c.status == "In Progress" %}
                                <span class="badge bg-info text-dark">In Progress</span>

                            {% elif c.status == "Resolved" %}
                                <span class="badge bg-success">Resolved</span>

                            {% elif c.status == "Rejected" %}
                                <span class="badge bg-danger">Rejected</span>

                            {% else %}
                                <span class="badge bg-secondary">{{ c.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ c.created_at }}</td>
                        <td class="text-end">
                            <button 
                                class="btn btn-sm btn-outline-secondary"
                                data-bs-toggle="modal"
                                data-bs-target="#complaintModal{{ c.complaint_id }}">
                                <i class="bi bi-eye"></i>
                                View
                            </button>
                        </td>
                        <td class="text-end">
                            {% if c.status == "Rejected" or c.status == "Resolved" %}
                                <a href="{{ url_for('admin.edit_status', complaint_id=c.complaint_id) }}"
                                class="btn btn-sm btn-outline-primary disabled" >
                                    <i class="bi bi-pencil-square"></i>
                                    Change
                                </a>
                            {% else %}
                                <a href="{{ url_for('admin.edit_status', complaint_id=c.complaint_id) }}"
                                class="btn btn-sm btn-outline-primary" >
                                    <i class="bi bi-pencil-square"></i>
                                    Change
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- IF NO COMPLAINTS -->
            {% else %}
                {% if status %}
                    <div class="p-4 text-center">
                        <h6 class="text-muted">No {{ status }} complaints</h6>
                    </div>
                {% else %}
                    <div class="p-4 text-center">
                        <h6 class="text-muted">No filed complaints</h6>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <div class="d-flex justify-content-end px-3 ">
        <a href="{{ url_for('admin.admin_home') }}" class="btn btn-secondary mt-3 px-3">
            <i class="bi bi-arrow-left"></i>
            Back
        </a>
    </div>

    <!-- FLASH MESSAGES -->
    <div class="flash-messages text-center mt-3">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- MODAL FOR VIEWING COMPLAINT STATUS -->
    {% for c in complaints %}
        <div class="modal fade" id="complaintModal{{ c.complaint_id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">

                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">Complaint #{{ c.complaint_id }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                        <p><strong>User : </strong> {{ c.username }}</p>
                        <p><strong>Title : </strong> {{ c.title }}</p>
                        <p><strong>Department : </strong>{{ c.department_name }}</p>

                        <p><strong>Description: </strong><br>
                        {{ c.description }}</p>

                        <p><strong>Status : </strong>
                        {% if c.status == "Pending" %}
                            <span class="badge bg-warning text-dark">Pending</span>
                        {% elif c.status == "In Progress" %}
                            <span class="badge bg-info text-dark">In Progress</span>
                        {% elif c.status == "Resolved" %}
                            <span class="badge bg-success">Resolved</span>
                        {% elif c.status == "Rejected" %}
                            <span class="badge bg-danger">Rejected</span>
                        {% endif %}
                        </p>

                        <p><strong>Created AT : </strong> {{ c.created_at }}</p>

                        {% if c.attachment %}
                        <a href="{{ url_for('static', filename='uploads/' ~ c.attachment) }}" target="_blank" class="btn btn-sm btn-outline-info mb-3">
                            View attachment
                        </a>
                        {% endif %}

                        <!-- ADMIN COMMENT -->
                        <form method="POST" action="{{ url_for('admin.add_comment', complaint_id=c.complaint_id) }}">
                            {% if c.status == "Resolved" or c.status == "Rejected" %}
                                <div class="mb-2">
                                    <label for="admin_comment" class="form-label"><strong>Admin Comment</strong></label>
                                    <input id="admin_comment" type="text" name="admin_comment" class="form-control mt-1" value="{{ c.admin_comment or '' }}" disabled>
                                </div>
                                <button type="submit" class="btn btn-success mt-1 disabled">
                                    <i class="bi bi-plus-lg me-1"></i>
                                    Add Comment
                                </button>
                            {% else %}
                                <div class="mb-2">
                                    <label for="admin_comment" class="form-label"><strong>Admin Comment</strong></label>
                                    <input id="admin_comment" type="text" name="admin_comment" class="form-control mt-1" value="{{ c.admin_comment or '' }}">
                                </div>
                                <button type="submit" class="btn btn-success mt-1">
                                    <i class="bi bi-plus-lg me-1"></i>
                                    Add Comment
                                </button>
                            {% endif %}
                        </form>
                    </div>

                    <div class="modal-footer">
                        {% if c.status == "Pending" %}
                            <a href="{{ url_for('admin.assign_complaint', complaint_id=c.complaint_id, department_id=c.department_id) }}"
                            class="btn btn-primary">
                                <i class="bi bi-person-check me-1"></i>
                                Assign 
                            </a>
                        {% endif %}
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    
    <!-- PAGINATION FUNCTIONALITY-->
    {% if page %}
        <div class="d-flex justify-content-center align-items-center mt-4 mb-5 gap-3">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}{% if status %}&status={{status}}{% endif %}" class="btn btn-secondary">Previous</a>
            {% endif %}
        
            <span>Page {{ page }} of {{ total_pages }}</span>
        
            {% if page < total_pages %} <a href="?page={{ page + 1 }}{% if status %}&status={{status}}{% endif %}"
                class="btn btn-secondary">Next</a>
                {% endif %}
        </div>
    {% endif %}
    
</div>
{% endblock %}